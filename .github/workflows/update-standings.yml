# GitHub Actions Workflow - Automated Standings Updates
#
# Runs daily to check for completed gameweeks and update standings
# Only saves when all 20 teams have played equal number of games

name: Update Premier League Standings

on:
  # Run every day at 3 AM UTC (10 PM EST / 7 PM PST)
  schedule:
    - cron: '0 3 * * *'

  # Allow manual triggering from GitHub Actions tab
  workflow_dispatch:

jobs:
  update-standings:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need full history to commit changes back
          fetch-depth: 0

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Run the standings update script
      - name: Update standings
        env:
          FOOTBALL_API_KEY: ${{ secrets.FOOTBALL_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: npm run update-standings

      # Step 5: Check if there are changes to commit
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code src/data/standingsByGameweek.json || echo "changed=true" >> $GITHUB_OUTPUT

      # Step 6: Commit and push changes if standings were updated
      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/data/standingsByGameweek.json
          git add src/data/scoresByGameweek.json
          git add src/data/missed-gameweeks.json
          git commit -m "Auto-update: Premier League standings $(date +'%Y-%m-%d %H:%M UTC')"
          git push

      # Step 7: Upload logs as artifact (for debugging)
      - name: Upload run logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: standings-update-log-${{ github.run_number }}
          path: |
            src/data/standingsByGameweek.json
            src/data/missed-gameweeks.json
          retention-days: 30
